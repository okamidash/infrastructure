#cloud-config
users:
{% for user in system_users %}
  - name: {{ user }}
    gecos: {{ user }}
    lock-passwd: false
    sudo: ALL=(ALL) NOPASSWD:ALL
    passwd: {{ system_users[user].password }}
    ssh_authorized_keys:
      - {{ system_users[user].ssh_key }}
{% endfor %}

timezone: Europe/London
locale: en_GB.UTF-8

{% if network_address | ipaddr %}
{# Done because cloud-init networking is broken #}
write_files:
  - path: /etc/sysconfig/network-scripts/ifcfg-eth0
    content: |
      DEVICE="eth0"
      NM_CONTROLLED="yes"
      ONBOOT=yes
      TYPE=Ethernet
      BOOTPROTO=static
      NAME="System eth0"
      IPADDR={{ network_address | ipaddr('address') }}
      NETMASK={{ network_address | ipaddr('netmask') }}
      NETWORK={{ network_address | ipaddr('network') }}
      GATEWAY={{ system_networks[network].gateway }}
      DOMAIN={{ system_networks[network].subdomain }}.{{ domain }}
      DNS1={{ dns_server }}
{% endif %}
power_state:
  mode: reboot
  message: Bye Bye
  timeout: 30
  condition: True

runcmd:
  - touch /etc/cloud/cloud-init.disabled
