---
- set_fact: vm_subdomain="{{ inventory_hostname.split('.')[1] }}"
  when: inventory_hostname.split('.')[1] != "vm"

- debug: msg="{{ cloud_init }}"
- set_fact: network="{{ item.key }}"
  with_dict: "{{ system_networks }}"
  when:
    - vm_subdomain is defined
    - item.value.subdomain == vm_subdomain

- set_fact: hypervisor_host="{{ groups['hypervisors'] | random }}" undef="True"
  when: hypervisor_host is undefined

- debug: msg="Hypervisor host was undefined, Deploying onto {{ hypervisor_host }}"
  when: undef is defined

- include: setup_image.yml
  delegate_to: "{{ hypervisor_host }}"
